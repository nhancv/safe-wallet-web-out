"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[854],{5587:(e,t,n)=>{n.d(t,{_:()=>o});var i=n(67800),r=n(71065);function o(e,t){var n="object"==typeof t;return new Promise(function(o,s){var c=new r.Ms({next:function(e){o(e),c.unsubscribe()},error:s,complete:function(){n?o(t.defaultValue):s(new i.G)}});e.subscribe(c)})}},11032:(e,t,n)=>{n.d(t,{n:()=>s});var i=n(43414),r=n(32224),o=n(42948);function s(e,t){return(0,r.N)(function(n,r){var s=null,c=0,a=!1,u=function(){return a&&!s&&r.complete()};n.subscribe((0,o._)(r,function(n){null==s||s.unsubscribe();var a=0,d=c++;(0,i.Tg)(e(n,d)).subscribe(s=(0,o._)(r,function(e){return r.next(t?t(n,e,d,a++):e)},function(){s=null,u()}))},function(){a=!0,u()}))})}},57279:(e,t,n)=>{n.d(t,{B:()=>s,V:()=>o});var i=n(67346),r={};function o(){return(0,i.wD)()?n.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:r}function s(e,t,n){var i=n||o(),r=i.__SENTRY__=i.__SENTRY__||{};return r[e]||(r[e]=t())}},67346:(e,t,n)=>{n.d(t,{fj:()=>o,wD:()=>r}),e=n.hmd(e);var i=n(29143);function r(){return!("undefined"!=typeof __SENTRY_BROWSER_BUNDLE__&&__SENTRY_BROWSER_BUNDLE__)&&"[object process]"===Object.prototype.toString.call(void 0!==i?i:0)}function o(e,t){return e.require(t)}},67800:(e,t,n)=>{n.d(t,{G:()=>i});var i=(0,n(30951).L)(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}})},80854:(e,t,n)=>{n.d(t,{webHidIdentifier:()=>$,webHidTransportFactory:()=>z});var i,r=n(72220);class o extends r.GeneralDmkError{constructor(e){super(e),this.err=e}_tag="WebHidTransportNotSupportedError"}class s extends r.GeneralDmkError{constructor(e){super(e),this.err=e}_tag="WebHidSendReportError"}var c=function(){return(c=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function a(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,r,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s}(arguments[t]));return e}var u=n(57279);function d(){var e=(0,u.V)(),t=e.crypto||e.msCrypto;if(void 0!==t&&t.getRandomValues){var n=new Uint16Array(8);t.getRandomValues(n),n[3]=4095&n[3]|16384,n[4]=16383&n[4]|32768;var i=function(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t};return i(n[0])+i(n[1])+i(n[2])+i(n[3])+i(n[4])+i(n[5])+i(n[6])+i(n[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}var h=n(93661),p="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,v=(0,u.V)(),l=["debug","info","warn","error","log","assert"];function _(e){var t=(0,u.V)();if(!("console"in t))return e();var n=t.console,i={};l.forEach(function(e){var r=n[e]&&n[e].__sentry_original__;e in t.console&&r&&(i[e]=n[e],n[e]=r)});try{return e()}finally{Object.keys(i).forEach(function(e){n[e]=i[e]})}}function f(){var e=!1,t={enable:function(){e=!0},disable:function(){e=!1}};return p?l.forEach(function(n){t[n]=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];e&&_(function(){var e;(e=v.console)[n].apply(e,a(["Sentry Logger ["+n+"]:"],t))})}}):l.forEach(function(e){t[e]=function(){}}),t}i=p?(0,u.B)("logger",f):f();var g=n(67346),y="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,b=Object.prototype.toString;function S(e){var t;return t=e,"[object Object]"===b.call(t)}function m(e){return!!(e&&e.then&&"function"==typeof e.then)}var D=function(){function e(e){var t=this;this._state=0,this._handlers=[],this._resolve=function(e){t._setResult(1,e)},this._reject=function(e){t._setResult(2,e)},this._setResult=function(e,n){if(0===t._state){if(m(n)){n.then(t._resolve,t._reject);return}t._state=e,t._value=n,t._executeHandlers()}},this._executeHandlers=function(){if(0!==t._state){var e=t._handlers.slice();t._handlers=[],e.forEach(function(e){!e[0]&&(1===t._state&&e[1](t._value),2===t._state&&e[2](t._value),e[0]=!0)})}};try{e(this._resolve,this._reject)}catch(e){this._reject(e)}}return e.prototype.then=function(t,n){var i=this;return new e(function(e,r){i._handlers.push([!1,function(n){if(t)try{e(t(n))}catch(e){r(e)}else e(n)},function(t){if(n)try{e(n(t))}catch(e){r(e)}else r(t)}]),i._executeHandlers()})},e.prototype.catch=function(e){return this.then(function(e){return e},e)},e.prototype.finally=function(t){var n=this;return new e(function(e,i){var r,o;return n.then(function(e){o=!1,r=e,t&&t()},function(e){o=!0,r=e,t&&t()}).then(function(){if(o){i(r);return}e(r)})})},e}(),x=function(){function e(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={}}return e.clone=function(t){var n=new e;return t&&(n._breadcrumbs=a(t._breadcrumbs),n._tags=c({},t._tags),n._extra=c({},t._extra),n._contexts=c({},t._contexts),n._user=t._user,n._level=t._level,n._span=t._span,n._session=t._session,n._transactionName=t._transactionName,n._fingerprint=t._fingerprint,n._eventProcessors=a(t._eventProcessors),n._requestSession=t._requestSession),n},e.prototype.addScopeListener=function(e){this._scopeListeners.push(e)},e.prototype.addEventProcessor=function(e){return this._eventProcessors.push(e),this},e.prototype.setUser=function(e){return this._user=e||{},this._session&&this._session.update({user:e}),this._notifyScopeListeners(),this},e.prototype.getUser=function(){return this._user},e.prototype.getRequestSession=function(){return this._requestSession},e.prototype.setRequestSession=function(e){return this._requestSession=e,this},e.prototype.setTags=function(e){return this._tags=c(c({},this._tags),e),this._notifyScopeListeners(),this},e.prototype.setTag=function(e,t){var n;return this._tags=c(c({},this._tags),((n={})[e]=t,n)),this._notifyScopeListeners(),this},e.prototype.setExtras=function(e){return this._extra=c(c({},this._extra),e),this._notifyScopeListeners(),this},e.prototype.setExtra=function(e,t){var n;return this._extra=c(c({},this._extra),((n={})[e]=t,n)),this._notifyScopeListeners(),this},e.prototype.setFingerprint=function(e){return this._fingerprint=e,this._notifyScopeListeners(),this},e.prototype.setLevel=function(e){return this._level=e,this._notifyScopeListeners(),this},e.prototype.setTransactionName=function(e){return this._transactionName=e,this._notifyScopeListeners(),this},e.prototype.setTransaction=function(e){return this.setTransactionName(e)},e.prototype.setContext=function(e,t){var n;return null===t?delete this._contexts[e]:this._contexts=c(c({},this._contexts),((n={})[e]=t,n)),this._notifyScopeListeners(),this},e.prototype.setSpan=function(e){return this._span=e,this._notifyScopeListeners(),this},e.prototype.getSpan=function(){return this._span},e.prototype.getTransaction=function(){var e=this.getSpan();return e&&e.transaction},e.prototype.setSession=function(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this},e.prototype.getSession=function(){return this._session},e.prototype.update=function(t){if(!t)return this;if("function"==typeof t){var n=t(this);return n instanceof e?n:this}return t instanceof e?(this._tags=c(c({},this._tags),t._tags),this._extra=c(c({},this._extra),t._extra),this._contexts=c(c({},this._contexts),t._contexts),t._user&&Object.keys(t._user).length&&(this._user=t._user),t._level&&(this._level=t._level),t._fingerprint&&(this._fingerprint=t._fingerprint),t._requestSession&&(this._requestSession=t._requestSession)):S(t)&&(this._tags=c(c({},this._tags),t.tags),this._extra=c(c({},this._extra),t.extra),this._contexts=c(c({},this._contexts),t.contexts),t.user&&(this._user=t.user),t.level&&(this._level=t.level),t.fingerprint&&(this._fingerprint=t.fingerprint),t.requestSession&&(this._requestSession=t.requestSession)),this},e.prototype.clear=function(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._requestSession=void 0,this._span=void 0,this._session=void 0,this._notifyScopeListeners(),this},e.prototype.addBreadcrumb=function(e,t){var n="number"==typeof t?Math.min(t,100):100;if(n<=0)return this;var i=c({timestamp:(0,h.lu)()},e);return this._breadcrumbs=a(this._breadcrumbs,[i]).slice(-n),this._notifyScopeListeners(),this},e.prototype.clearBreadcrumbs=function(){return this._breadcrumbs=[],this._notifyScopeListeners(),this},e.prototype.applyToEvent=function(e,t){if(this._extra&&Object.keys(this._extra).length&&(e.extra=c(c({},this._extra),e.extra)),this._tags&&Object.keys(this._tags).length&&(e.tags=c(c({},this._tags),e.tags)),this._user&&Object.keys(this._user).length&&(e.user=c(c({},this._user),e.user)),this._contexts&&Object.keys(this._contexts).length&&(e.contexts=c(c({},this._contexts),e.contexts)),this._level&&(e.level=this._level),this._transactionName&&(e.transaction=this._transactionName),this._span){e.contexts=c({trace:this._span.getTraceContext()},e.contexts);var n=this._span.transaction&&this._span.transaction.name;n&&(e.tags=c({transaction:n},e.tags))}return this._applyFingerprint(e),e.breadcrumbs=a(e.breadcrumbs||[],this._breadcrumbs),e.breadcrumbs=e.breadcrumbs.length>0?e.breadcrumbs:void 0,e.sdkProcessingMetadata=this._sdkProcessingMetadata,this._notifyEventProcessors(a(function(){return(0,u.B)("globalEventProcessors",function(){return[]})}(),this._eventProcessors),e,t)},e.prototype.setSDKProcessingMetadata=function(e){return this._sdkProcessingMetadata=c(c({},this._sdkProcessingMetadata),e),this},e.prototype._notifyEventProcessors=function(e,t,n,i){var r=this;return void 0===i&&(i=0),new D(function(o,s){var a=e[i];if(null===t||"function"!=typeof a)o(t);else{var u=a(c({},t),n);m(u)?u.then(function(t){return r._notifyEventProcessors(e,t,n,i+1).then(o)}).then(null,s):r._notifyEventProcessors(e,u,n,i+1).then(o).then(null,s)}})},e.prototype._notifyScopeListeners=function(){var e=this;this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(function(t){t(e)}),this._notifyingListeners=!1)},e.prototype._applyFingerprint=function(e){e.fingerprint=e.fingerprint?Array.isArray(e.fingerprint)?e.fingerprint:[e.fingerprint]:[],this._fingerprint&&(e.fingerprint=e.fingerprint.concat(this._fingerprint)),e.fingerprint&&!e.fingerprint.length&&delete e.fingerprint},e}(),E=function(){function e(e){this.errors=0,this.sid=d(),this.duration=0,this.status="ok",this.init=!0,this.ignoreDuration=!1;var t=(0,h.zf)();this.timestamp=t,this.started=t,e&&this.update(e)}return e.prototype.update=function(e){if(void 0===e&&(e={}),!e.user||(!this.ipAddress&&e.user.ip_address&&(this.ipAddress=e.user.ip_address),this.did||e.did||(this.did=e.user.id||e.user.email||e.user.username)),this.timestamp=e.timestamp||(0,h.zf)(),e.ignoreDuration&&(this.ignoreDuration=e.ignoreDuration),e.sid&&(this.sid=32===e.sid.length?e.sid:d()),void 0!==e.init&&(this.init=e.init),!this.did&&e.did&&(this.did=""+e.did),"number"==typeof e.started&&(this.started=e.started),this.ignoreDuration)this.duration=void 0;else if("number"==typeof e.duration)this.duration=e.duration;else{var t=this.timestamp-this.started;this.duration=t>=0?t:0}e.release&&(this.release=e.release),e.environment&&(this.environment=e.environment),!this.ipAddress&&e.ipAddress&&(this.ipAddress=e.ipAddress),!this.userAgent&&e.userAgent&&(this.userAgent=e.userAgent),"number"==typeof e.errors&&(this.errors=e.errors),e.status&&(this.status=e.status)},e.prototype.close=function(e){e?this.update({status:e}):"ok"===this.status?this.update({status:"exited"}):this.update()},e.prototype.toJSON=function(){return function e(t){var n,i;if(S(t)){var r={};try{for(var o=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(Object.keys(t)),s=o.next();!s.done;s=o.next()){var c=s.value;void 0!==t[c]&&(r[c]=e(t[c]))}}catch(e){n={error:e}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return r}return Array.isArray(t)?t.map(e):t}({sid:""+this.sid,init:this.init,started:new Date(1e3*this.started).toISOString(),timestamp:new Date(1e3*this.timestamp).toISOString(),status:this.status,errors:this.errors,did:"number"==typeof this.did||"string"==typeof this.did?""+this.did:void 0,duration:this.duration,attrs:{release:this.release,environment:this.environment,ip_address:this.ipAddress,user_agent:this.userAgent}})},e}(),w=function(){function e(e,t,n){void 0===t&&(t=new x),void 0===n&&(n=4),this._version=n,this._stack=[{}],this.getStackTop().scope=t,e&&this.bindClient(e)}return e.prototype.isOlderThan=function(e){return this._version<e},e.prototype.bindClient=function(e){this.getStackTop().client=e,e&&e.setupIntegrations&&e.setupIntegrations()},e.prototype.pushScope=function(){var e=x.clone(this.getScope());return this.getStack().push({client:this.getClient(),scope:e}),e},e.prototype.popScope=function(){return!(this.getStack().length<=1)&&!!this.getStack().pop()},e.prototype.withScope=function(e){var t=this.pushScope();try{e(t)}finally{this.popScope()}},e.prototype.getClient=function(){return this.getStackTop().client},e.prototype.getScope=function(){return this.getStackTop().scope},e.prototype.getStack=function(){return this._stack},e.prototype.getStackTop=function(){return this._stack[this._stack.length-1]},e.prototype.captureException=function(e,t){var n=this._lastEventId=t&&t.event_id?t.event_id:d(),i=t;if(!t){var r=void 0;try{throw Error("Sentry syntheticException")}catch(e){r=e}i={originalException:e,syntheticException:r}}return this._invokeClient("captureException",e,c(c({},i),{event_id:n})),n},e.prototype.captureMessage=function(e,t,n){var i=this._lastEventId=n&&n.event_id?n.event_id:d(),r=n;if(!n){var o=void 0;try{throw Error(e)}catch(e){o=e}r={originalException:e,syntheticException:o}}return this._invokeClient("captureMessage",e,t,c(c({},r),{event_id:i})),i},e.prototype.captureEvent=function(e,t){var n=t&&t.event_id?t.event_id:d();return"transaction"!==e.type&&(this._lastEventId=n),this._invokeClient("captureEvent",e,c(c({},t),{event_id:n})),n},e.prototype.lastEventId=function(){return this._lastEventId},e.prototype.addBreadcrumb=function(e,t){var n=this.getStackTop(),i=n.scope,r=n.client;if(i&&r){var o=r.getOptions&&r.getOptions()||{},s=o.beforeBreadcrumb,a=void 0===s?null:s,u=o.maxBreadcrumbs,d=void 0===u?100:u;if(!(d<=0)){var p=(0,h.lu)(),v=c({timestamp:p},e),l=a?_(function(){return a(v,t)}):v;null!==l&&i.addBreadcrumb(l,d)}}},e.prototype.setUser=function(e){var t=this.getScope();t&&t.setUser(e)},e.prototype.setTags=function(e){var t=this.getScope();t&&t.setTags(e)},e.prototype.setExtras=function(e){var t=this.getScope();t&&t.setExtras(e)},e.prototype.setTag=function(e,t){var n=this.getScope();n&&n.setTag(e,t)},e.prototype.setExtra=function(e,t){var n=this.getScope();n&&n.setExtra(e,t)},e.prototype.setContext=function(e,t){var n=this.getScope();n&&n.setContext(e,t)},e.prototype.configureScope=function(e){var t=this.getStackTop(),n=t.scope,i=t.client;n&&i&&e(n)},e.prototype.run=function(e){var t=C(this);try{e(this)}finally{C(t)}},e.prototype.getIntegration=function(e){var t=this.getClient();if(!t)return null;try{return t.getIntegration(e)}catch(t){return y&&i.warn("Cannot retrieve integration "+e.id+" from the current Hub"),null}},e.prototype.startSpan=function(e){return this._callExtensionMethod("startSpan",e)},e.prototype.startTransaction=function(e,t){return this._callExtensionMethod("startTransaction",e,t)},e.prototype.traceHeaders=function(){return this._callExtensionMethod("traceHeaders")},e.prototype.captureSession=function(e){if(void 0===e&&(e=!1),e)return this.endSession();this._sendSessionUpdate()},e.prototype.endSession=function(){var e=this.getStackTop(),t=e&&e.scope,n=t&&t.getSession();n&&n.close(),this._sendSessionUpdate(),t&&t.setSession()},e.prototype.startSession=function(e){var t=this.getStackTop(),n=t.scope,i=t.client,r=i&&i.getOptions()||{},o=r.release,s=r.environment,a=((0,u.V)().navigator||{}).userAgent,d=new E(c(c(c({release:o,environment:s},n&&{user:n.getUser()}),a&&{userAgent:a}),e));if(n){var h=n.getSession&&n.getSession();h&&"ok"===h.status&&h.update({status:"exited"}),this.endSession(),n.setSession(d)}return d},e.prototype._sendSessionUpdate=function(){var e=this.getStackTop(),t=e.scope,n=e.client;if(t){var i=t.getSession&&t.getSession();i&&n&&n.captureSession&&n.captureSession(i)}},e.prototype._invokeClient=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var i=this.getStackTop(),r=i.scope,o=i.client;o&&o[e]&&o[e].apply(o,a(t,[r]))},e.prototype._callExtensionMethod=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=T().__SENTRY__;if(r&&r.extensions&&"function"==typeof r.extensions[e])return r.extensions[e].apply(this,t);y&&i.warn("Extension method "+e+" couldn't be found, doing nothing.")},e}();function T(){var e=(0,u.V)();return e.__SENTRY__=e.__SENTRY__||{extensions:{},hub:void 0},e}function C(e){var t=T(),n=A(t);return I(t,e),n}function R(e){return!!(e&&e.__SENTRY__&&e.__SENTRY__.hub)}function A(e){return(0,u.B)("hub",function(){return new w},e)}function I(e,t){return!!e&&((e.__SENTRY__=e.__SENTRY__||{}).hub=t,!0)}function N(e,t){return function(e){for(var t,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];var r=((!R(t=T())||A(t).isOlderThan(4))&&I(t,new w),(0,g.wD)())?function(e){try{var t=T().__SENTRY__,n=t&&t.extensions&&t.extensions.domain&&t.extensions.domain.active;if(!n)return A(e);if(!R(n)||A(n).isOlderThan(4)){var i=A(e).getStackTop();I(n,new w(i.client,x.clone(i.scope)))}return A(n)}catch(t){return A(e)}}(t):A(t);if(r&&r[e])return r[e].apply(r,function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,r,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s}(arguments[t]));return e}(n));throw Error("No hub defined or "+e+" was not found on the hub, please open a bug report.")}("captureException",e,{captureContext:t,originalException:e,syntheticException:Error("Sentry syntheticException")})}var k=n(26684),L=n(83302),H=n(32940),O=n(82663),M=n(11032),P=n(36002),j=n(90061),B=n(5587),U=n(32224),F=n(42948),q=n(78159),Y=n(22079),V=n(43414);class W{_device;_deviceId;_apduSender;_apduReceiver;_sendApduSubject=new j.B;_logger;_pendingApdu=k.Cl;_onConnectionTerminated;reconnectionSubject=new j.B;waitingForReconnection=!1;lostConnectionTimeout=null;terminated=!1;constructor({device:e,deviceId:t,apduSender:n,apduReceiver:i,onConnectionTerminated:r},o){this._apduSender=n,this._apduReceiver=i,this._onConnectionTerminated=r,this._logger=o("WebHidDeviceConnection"),this._device=e,this._device.oninputreport=e=>this.receiveHidInputReport(e),this._deviceId=t,this._logger.info("\uD83D\uDD0C Connected to device")}get device(){return this._device}get deviceId(){return this._deviceId}async sendApdu(e,t){this._sendApduSubject=new j.B,this._pendingApdu=k.bW.of(e),this._logger.debug("Sending APDU",{data:{apdu:e},tag:"apdu-sender"});let n=new Promise(e=>{this._sendApduSubject.subscribe({next:async n=>{this._pendingApdu=k.Cl,t&&r.CommandUtils.isSuccessResponse(n)?(await this.waitForReconnection()).caseOf({Left:t=>e((0,k.MN)(t)),Right:()=>e((0,k.xe)(n))}):e((0,k.xe)(n))},error:t=>{this._pendingApdu=k.Cl,e((0,k.MN)(t))}})});if(this.waitingForReconnection||!this.device.opened){let e=this.device.opened&&this._pendingApdu.isJust(),t=await this.waitForReconnection(e);if(t.isLeft())return t}for(let t of this._apduSender.getFrames(e)){this._logger.debug("Sending Frame",{data:{frame:t.getRawData()}});try{await (0,B._)((0,O.H)(this._device.sendReport(0,t.getRawData())).pipe(function(e){void 0===e&&(e=1/0);var t=e&&"object"==typeof e?e:{count:e},n=t.count,i=void 0===n?1/0:n,r=t.delay,o=t.resetOnSuccess,s=void 0!==o&&o;return i<=0?q.D:(0,U.N)(function(e,t){var n,o=0,c=function(){var a=!1;n=e.subscribe((0,F._)(t,function(e){s&&(o=0),t.next(e)},void 0,function(e){if(o++<i){var s=function(){n?(n.unsubscribe(),n=null,c()):a=!0};if(null!=r){var u="number"==typeof r?(0,Y.O)(r):(0,V.Tg)(r(e,o)),d=(0,F._)(t,function(){d.unsubscribe(),s()},function(){t.complete()});u.subscribe(d)}else s()}else t.error(e)})),a&&(n.unsubscribe(),n=null,c())};c()})}({count:3,delay:500})))}catch(e){return this._logger.error("Error sending frame",{data:{error:e}}),Promise.resolve((0,k.MN)(new s(e)))}}return n}receiveHidInputReport(e){let t=new Uint8Array(e.data.buffer);this._logger.debug("Received Frame",{data:{frame:t},tag:"apdu-receiver"}),this._apduReceiver.handleFrame(t).caseOf({Right:e=>{e.map(e=>{this._logger.debug("Received APDU Response",{data:{response:e}}),this._sendApduSubject.next(e),this._sendApduSubject.complete()})},Left:e=>{this._sendApduSubject.error(e)}})}waitForReconnection(e=!1){return this.terminated?Promise.resolve((0,k.MN)(new r.ReconnectionFailedError)):new Promise(t=>{let n=this.reconnectionSubject.subscribe({next:i=>{e&&this._sendApduSubject.error(new s(Error("Device disconnected while waiting for device response"))),t("success"===i?(0,k.xe)(void 0):(0,k.MN)(i)),n.unsubscribe()}})})}lostConnection(){this._logger.info("⏱️ Lost connection, starting timer"),this.waitingForReconnection=!0,this.lostConnectionTimeout=setTimeout(()=>{this._logger.info("❌ Disconnection timeout, terminating connection"),this.disconnect()},6e3)}async reconnectHidDevice(e){this._device=e,this._device.oninputreport=e=>this.receiveHidInputReport(e),this.lostConnectionTimeout&&clearTimeout(this.lostConnectionTimeout),this._pendingApdu.isJust()&&this._sendApduSubject.error(new s),await e.open(),this._logger.info("⏱️\uD83D\uDD0C Device reconnected"),this.waitingForReconnection=!1,this.reconnectionSubject.next("success")}disconnect(){this._pendingApdu.isJust()&&this._sendApduSubject.error(new s),this._logger.info("\uD83D\uDD1A Disconnect"),this.lostConnectionTimeout&&clearTimeout(this.lostConnectionTimeout),this.terminated=!0,this._onConnectionTerminated(),this.reconnectionSubject.next(new r.ReconnectionFailedError)}}let $="WEB-HID";class G{constructor(e,t,n,i){this._deviceModelDataSource=e,this._loggerServiceFactory=t,this._apduSenderFactory=n,this._apduReceiverFactory=i,this._logger=t("WebWebHidTransport"),this.startListeningToConnectionEvents()}_transportDiscoveredDevices=new L.t([]);_deviceConnectionsByHidDevice=new Map;_deviceConnectionsPendingReconnection=new Set;_connectionListenersAbortController=new AbortController;_logger;connectionType="USB";identifier=$;get hidApi(){return this.isSupported()?(0,k.xe)(navigator.hid):(0,k.MN)(new o("WebHID not supported"))}isSupported(){try{let e=!!navigator?.hid;return this._logger.debug(`isSupported: ${e}`),e}catch(e){return this._logger.error("isSupported: error",{data:{error:e}}),!1}}getIdentifier(){return this.identifier}async getDevices(){return k.o3.liftEither(this.hidApi).map(async e=>{try{return(await e.getDevices()).filter(e=>e.vendorId===r.LEDGER_VENDOR_ID)}catch(t){let e=new r.NoAccessibleDeviceError(t);throw this._logger.error("getDevices: error getting devices",{data:{error:t}}),N(e),e}})}mapHIDDeviceToTransportDiscoveredDevice(e){let t=this._transportDiscoveredDevices.getValue().find(t=>t.hidDevice===e);if(t)return t;let n=this._deviceConnectionsByHidDevice.get(e);return this.getDeviceModel(e).caseOf({Just:t=>{let i=n?.deviceId??(0,P.A)(),r={id:i,deviceModel:t,hidDevice:e,transport:this.identifier};return this._logger.debug(`Discovered device ${i} ${r.deviceModel.productName}`),r},Nothing:()=>{throw this._logger.warn(`Device not recognized: hidDevice.productId: 0x${e.productId.toString(16)}`),new r.DeviceNotRecognizedError(`Device not recognized: hidDevice.productId: 0x${e.productId.toString(16)}`)}})}listenToAvailableDevices(){return this.updateTransportDiscoveredDevices(),this._transportDiscoveredDevices.pipe((0,H.T)(e=>e.map(({hidDevice:e,...t})=>t)))}async updateTransportDiscoveredDevices(){(await this.getDevices()).caseOf({Left:e=>{this._logger.error("Error while getting accessible device",{data:{error:e}}),N(e)},Right:e=>{this._transportDiscoveredDevices.next(e.map(e=>this.mapHIDDeviceToTransportDiscoveredDevice(e)))}})}async promptDeviceAccess(){return k.o3.liftEither(this.hidApi).map(async e=>{let t=[];try{t=await e.requestDevice({filters:[{vendorId:r.LEDGER_VENDOR_ID}]}),await this.updateTransportDiscoveredDevices()}catch(t){let e=new r.NoAccessibleDeviceError(t);throw this._logger.error("promptDeviceAccess: error requesting device",{data:{error:t}}),N(e),e}if(this._logger.debug(`promptDeviceAccess: hidDevices len ${t.length}`),0===t.length)throw this._logger.warn("No device was selected"),new r.NoAccessibleDeviceError("No selected device");let n=[];for(let e of t)n.push(e),this._logger.debug("promptDeviceAccess: selected device",{data:{hidDevice:e}});return n}).run()}startDiscovering(){return this._logger.debug("startDiscovering"),(0,O.H)(this.promptDeviceAccess()).pipe((0,M.n)(e=>e.caseOf({Left:e=>{throw this._logger.error("Error while getting accessible device",{data:{error:e}}),N(e),e},Right:e=>{this._logger.info(`Got access to ${e.length} HID devices`);let t=e.map(e=>this.mapHIDDeviceToTransportDiscoveredDevice(e));return(0,O.H)(t)}})))}stopDiscovering(){}startListeningToConnectionEvents(){this._logger.debug("startListeningToConnectionEvents"),this.hidApi.map(e=>{e.addEventListener("connect",e=>this.handleDeviceConnectionEvent(e),{signal:this._connectionListenersAbortController.signal}),e.addEventListener("disconnect",e=>this.handleDeviceDisconnectionEvent(e),{signal:this._connectionListenersAbortController.signal})})}stopListeningToConnectionEvents(){this._logger.debug("stopListeningToConnectionEvents"),this._connectionListenersAbortController.abort()}async connect({deviceId:e,onDisconnect:t}){this._logger.debug("connect",{data:{deviceId:e}});let n=this._transportDiscoveredDevices.getValue().find(t=>t.id===e);if(!n)return this._logger.error(`Unknown device ${e}`),(0,k.MN)(new r.UnknownDeviceError(`Unknown device ${e}`));try{if(this._deviceConnectionsByHidDevice.get(n.hidDevice))throw Error("Device already opened");await n.hidDevice.open()}catch(t){if(t instanceof DOMException&&"InvalidStateError"===t.name)this._logger.debug(`Device ${e} is already opened`);else{let n=new r.OpeningConnectionError(t);return this._logger.debug(`Error while opening device: ${e}`,{data:{error:t}}),N(n),(0,k.MN)(n)}}let{deviceModel:i}=n,o=k.bW.of(r.FramerUtils.numberToByteArray(Math.floor(65535*Math.random()),2)),s=new W({device:n.hidDevice,deviceId:e,apduSender:this._apduSenderFactory({frameSize:64,channel:o,padding:!0}),apduReceiver:this._apduReceiverFactory({channel:o}),onConnectionTerminated:()=>{t(e),this._deviceConnectionsPendingReconnection.delete(s),this._deviceConnectionsByHidDevice.delete(n.hidDevice),s.device.close()}},this._loggerServiceFactory);this._deviceConnectionsByHidDevice.set(n.hidDevice,s);let c=new r.TransportConnectedDevice({sendApdu:(e,t)=>s.sendApdu(e,t),deviceModel:i,id:e,type:this.connectionType,transport:this.identifier});return(0,k.xe)(c)}getDeviceModel(e){let{productId:t}=e,n=this._deviceModelDataSource.getAllDeviceModels().find(e=>e.usbProductId===t>>8||e.bootloaderUsbProductId===t);return n?k.bW.of(n):k.bW.zero()}getHidUsbProductId(e){return this.getDeviceModel(e).caseOf({Just:e=>e.usbProductId,Nothing:()=>e.productId>>8})}async disconnect(e){this._logger.debug("disconnect",{data:{connectedDevice:e}});let t=Array.from(this._deviceConnectionsByHidDevice.values()).find(t=>t.deviceId===e.connectedDevice.id);return t?(t.disconnect(),Promise.resolve((0,k.xe)(void 0))):(this._logger.error("No matching device connection found",{data:{connectedDevice:e}}),Promise.resolve((0,k.MN)(new r.UnknownDeviceError(`Unknown device ${e.connectedDevice.id}`))))}isHIDConnectionEvent(e){return"device"in e&&"object"==typeof e.device&&null!==e.device&&"productId"in e.device&&"number"==typeof e.device.productId}async handleDeviceDisconnectionEvent(e){if(!this.isHIDConnectionEvent(e)){this._logger.error("Invalid event",{data:{event:e}});return}this._logger.info("[handleDeviceDisconnectionEvent] Device disconnected",{data:{event:e}}),this.updateTransportDiscoveredDevices();try{await e.device.close()}catch(t){this._logger.error("Error while closing device ",{data:{event:e,error:t}})}let t=this._deviceConnectionsByHidDevice.get(e.device);t&&(t.lostConnection(),this._deviceConnectionsPendingReconnection.add(t),this._deviceConnectionsByHidDevice.delete(e.device))}handleDeviceReconnection(e,t){this._deviceConnectionsPendingReconnection.delete(e),this._deviceConnectionsByHidDevice.set(t,e);try{e.reconnectHidDevice(t)}catch(t){this._logger.error("Error while reconnecting to device",{data:{event,error:t}}),e.disconnect()}}handleDeviceConnectionEvent(e){if(!this.isHIDConnectionEvent(e)){this._logger.error("Invalid event",{data:{event:e}});return}this._logger.info("[handleDeviceConnectionEvent] Device connected",{data:{event:e}});let t=Array.from(this._deviceConnectionsPendingReconnection).find(t=>this.getHidUsbProductId(t.device)===this.getHidUsbProductId(e.device));t&&this.handleDeviceReconnection(t,e.device),this.updateTransportDiscoveredDevices()}destroy(){this.stopListeningToConnectionEvents(),this._deviceConnectionsByHidDevice.forEach(e=>{e.disconnect()}),this._deviceConnectionsPendingReconnection.clear()}}let z=({deviceModelDataSource:e,loggerServiceFactory:t,apduSenderServiceFactory:n,apduReceiverServiceFactory:i})=>new G(e,t,n,i)},93661:(e,t,n)=>{n.d(t,{lu:()=>a,zf:()=>u});var i=n(57279),r=n(67346);e=n.hmd(e);var o={nowSeconds:function(){return Date.now()/1e3}},s=(0,r.wD)()?function(){try{return(0,r.fj)(e,"perf_hooks").performance}catch(e){return}}():function(){var e=(0,i.V)().performance;if(e&&e.now)return{now:function(){return e.now()},timeOrigin:Date.now()-e.now()}}(),c=void 0===s?o:{nowSeconds:function(){return(s.timeOrigin+s.now())/1e3}},a=o.nowSeconds.bind(o),u=c.nowSeconds.bind(c);!function(){var e=(0,i.V)().performance;if(e&&e.now){var t=e.now(),n=Date.now(),r=e.timeOrigin?Math.abs(e.timeOrigin+t-n):36e5,o=e.timing&&e.timing.navigationStart,s="number"==typeof o?Math.abs(o+t-n):36e5;(r<36e5||s<36e5)&&r<=s&&e.timeOrigin}}()}}]);
//# sourceMappingURL=854.3b3255dd3ef62d70.js.map